name: DevSecOps Demo
on: [push]
permissions:
  contents: read
  packages: write
  issues: write

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'  # IMPORTANTE: Habilitar caché de Gradle


      - name: SonarCloud Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ./gradlew build sonarqube \
            -Dsonar.projectKey=andrestester1985-ctrl_log4shell-vulnerable-app \
            -Dsonar.organization=andrestester1985-ctrl \
            -Dsonar.host.url=https://sonarcloud.io \
      
      # 1. OPTIMIZACIÓN: Cache de la base de datos del NIST
      - name: Cache Dependency Check Data
        uses: actions/cache@v4
        with:
          # Ruta donde se guardan las firmas descargadas
          path: dependency-check/data
          # La llave incluye el OS para evitar conflictos
          key: ${{ runner.os }}-odc-db-v1
          restore-keys: |
            ${{ runner.os }}-odc-db-

    # 1. ESCANEO DE DEPENDENCIAS (Generando JSON para Sonar)
      - name: Security Dependency Scan (OWASP CLI)
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          VERSION="12.1.0"
          # CAMBIO CLAVE: Validamos si existe el BINARIO, no la carpeta de datos
          if [ ! -f "./dependency-check/bin/dependency-check.sh" ]; then
            echo "Instalando binarios de Dependency Check..."
            curl -sLO https://github.com/jeremylong/DependencyCheck/releases/download/v$VERSION/dependency-check-$VERSION-release.zip
            unzip -o -q dependency-check-$VERSION-release.zip # -o para sobrescribir si es necesario
          fi
          chmod +x ./dependency-check/bin/dependency-check.sh
          ./dependency-check/bin/dependency-check.sh \
            --project "Log4Shell-Demo" \
            --scan "build/libs" \
            --format "HTML" \
            --format "JSON" \
            --out "." \
            --nvdApiKey "$NVD_API_KEY" \
            --disableOssIndex \
            --failOnCVSS 11

      # 1. Levantar la aplicación con espera inteligente
      - name: Start App for DAST
        run: |
          REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker run -d -p 8080:8080 --name app-vulnerable ghcr.io/$REPO:latest
          echo "Esperando a que la app responda en el puerto 8080..."
          # Esto es mejor que el sleep porque confirma que la app está viva
          timeout 60s bash -c 'until [ "$(curl -s -o /dev/null -w "%{http_code}" localhost:8080/)" == "200" ]; do sleep 5; done'

      # 2. EJECUTAR DAST (Escaneo Dinámico manual)
      - name: Run ZAP DAST Scan
        run: |
          mkdir -p zap-reports
          chmod 777 zap-reports
          # Ejecutamos ZAP y le pedimos que guarde el reporte (-r)
          docker run --rm -v $(pwd)/zap-reports:/zap/wrk/:rw --network="host" \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://localhost:8080/ \
            -r zap_report.html
            
      # 3. GENERAR EL ARTEFACTO (Descargable)
      - name: Upload DAST Artifact
        uses: actions/upload-artifact@v4
        if: always() # Se sube aunque el paso anterior tenga advertencias
        with:
          name: zap-dast-report
          path: zap-reports/zap_report.html

      # 4. Limpiar contenedores
      - name: Stop App
        if: always()
        run: docker stop app-vulnerable && docker rm app-vulnerable

      # 2. SONARCLOUD SCAN (Vinculación Directa)
      - name: SonarCloud Scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ./gradlew sonarqube \
            -Dsonar.projectKey=andrestester1985-ctrl_log4shell-vulnerable-app \
            -Dsonar.organization=andrestester1985-ctrl \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.dependencyCheck.jsonReportPath=dependency-check-report.json \
            -Dsonar.dependencyCheck.htmlReportPath=dependency-check-report.html

      # 2. LOGIN EN REGISTRY (Solo si pasa el scan)
      - name: Login to GitHub Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. BUILD Y PUSH
      - name: Build and Push
        run: |
          REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker build -t ghcr.io/$REPO:latest .
          docker push ghcr.io/$REPO:latest
